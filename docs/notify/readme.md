# 回调通知说明

## 概述

自 `v1.19.0` 版本起，通过 `POST /api/v1/order/create-transaction` 创建的订单支持三种回调事件通知：

- ✅ **支付成功**
- ⏳ **等待支付**
- ⏰ **支付超时**

---

## 回调数据结构

三种回调事件的数据结构**完全一致**，唯一的区别在于 `status` 字段的值：

| Status 值 | 状态说明 | 触发时机        |
|----------|------|-------------|
| `1`      | 等待支付 | 订单创建后，每分钟推送 |
| `2`      | 支付成功 | 订单支付完成时     |
| `3`      | 支付超时 | 订单过期时       |

---

## 回调事件详解

### 1️⃣ 支付成功回调

**触发时机**：用户完成支付，系统确认收款后立即触发

**回调特性**：

- `status` 字段值为 `2`
- 支持失败重试机制

#### 成功条件

商户端需同时满足以下条件，系统才认定为回调成功：

- HTTP 响应状态码为 `200`
- 响应内容为 `ok`（不区分大小写）

#### 重试机制

若回调失败，系统将自动重试：

| 重试次数  | 时间间隔   |
|-------|--------|
| 第 1 次 | 2 分钟后  |
| 第 2 次 | 4 分钟后  |
| 第 3 次 | 8 分钟后  |
| 第 4 次 | 16 分钟后 |
| 第 5 次 | 32 分钟后 |
| 第 6 次 | 64 分钟后 |
| ...   | 以此类推   |

> 📌 **重试限制**：最多重试 10 次

---

### 2️⃣ 等待支付回调

**触发时机**：订单创建成功后立即触发，并持续推送直到订单状态变更

**回调特性**：

- `status` 字段值为 `1`
- 推送频率：**每分钟一次**
- 仅要求响应状态码为 `200` 即视为通知成功
- **不支持重试**

> ⚠️ **使用场景**：适用于商户需要实时监控订单状态的场景，例如在前端显示倒计时等待界面

---

### 3️⃣ 支付超时回调

**触发时机**：订单超过有效期未完成支付时触发

**回调特性**：

- `status` 字段值为 `3`
- **仅推送一次**，订单过期时发送
- 仅要求响应状态码为 `200` 即视为通知成功
- **不支持重试**

> 💡 **使用建议**：商户收到此回调后，应及时更新订单状态，避免用户误认为可以继续支付

---

## 接口规范

### 请求方式

```
POST {商户回调地址}
Content-Type: application/json
```

### 请求示例

```json
{
  "order_id": "20240107123456789",
  "amount": "100.00",
  "actual_amount": "100.00",
  "token": "USDT",
  "status": 2,
  "block_transaction_id": "0x1234567890abcdef...",
  "created_at": "2024-01-07T12:34:56Z",
  "expired_at": "2024-01-07T12:49:56Z"
}
```

### 响应规范

**成功响应**（针对支付成功回调）：

```
HTTP/1.1 200 OK
Content-Type: text/plain

ok
```

**通用成功响应**（针对等待支付和超时回调）：

```
HTTP/1.1 200 OK
```

---

## 安全建议

1. **验证签名**：建议商户对回调数据进行签名验证，确保数据来源真实可靠
2. **幂等性处理**：由于存在重试机制，商户端应做好幂等性处理，避免重复处理同一订单
3. **异步处理**：建议使用消息队列等异步方式处理回调，避免阻塞响应
4. **日志记录**：完整记录所有回调请求和响应，便于问题排查

---

## 常见问题

**Q：为什么支付成功回调一直失败？**

A：请检查：

- 回调地址是否可访问
- 响应状态码是否为 `200`
- 响应内容是否为 `ok`（注意大小写）
- 服务器是否有防火墙拦截

**Q：等待支付回调的频率可以调整吗？**

A：目前固定为每分钟一次，暂不支持自定义频率。

---
