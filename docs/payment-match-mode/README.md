# 交易匹配模式

订单过滤金额匹配时的不同对比算法，系统支持三种匹配模式，可根据实际业务场景选择合适的匹配策略。

---

## 传统模式（精确匹配）

最传统、最严格的金额匹配模式，实际交易金额和订单金额必须完全一致，才会被认为是匹配成功。

**适用场景：**

- 对金额准确性要求极高的场景

**举例：**

| 订单金额   | 实际交易金额 | 匹配结果   |
|--------|--------|--------|
| 100.00 | 100.00 | ✅ 匹配成功 |
| 100.00 | 100.01 | ❌ 匹配失败 |
| 99.99  | 99.99  | ✅ 匹配成功 |
| 99.99  | 99.98  | ❌ 匹配失败 |

---

## 前缀匹配

如同名字一般，前缀匹配模式会将两个交易金额转换成字符串，然后从左到右逐位进行对比。
如果订单金额字符串是实际交易金额字符串的前缀，则认为是匹配成功。

**适用场景：**

- 某些支付渠道可能会在金额末尾添加额外的小数位
- 用户可能因为汇率波动或手续费问题支付了稍多的金额
- 需要更灵活的金额匹配策略

**举例：**

| 订单金额   | 实际交易金额     | 匹配结果   | 说明                          |
|--------|------------|--------|-----------------------------|
| 100    | 100.5      | ✅ 匹配成功 | "100" 是 "100.5" 的前缀         |
| 100.5  | 100.56     | ✅ 匹配成功 | "100.5" 是 "100.56" 的前缀      |
| 99.9   | 99.99      | ✅ 匹配成功 | "99.9" 是 "99.99" 的前缀        |
| 100    | 99.99      | ❌ 匹配失败 | "100" 不是 "99.99" 的前缀        |
| 100.5  | 100.4      | ❌ 匹配失败 | "100.5" 不是 "100.4" 的前缀      |
| 123.45 | 123.456789 | ✅ 匹配成功 | "123.45" 是 "123.456789" 的前缀 |

---

## 修约匹配（四舍五入）

采用数值修约中的四舍五入规则，对实际交易金额进行修约处理后，再与订单金额进行对比。如果修约后的金额与订单金额一致，则认为是匹配成功。

**适用场景：**

- 加密货币交易，链上实际到账金额可能因为网络费用而略有差异
- 汇率换算导致的小数位精度问题
- 需要容忍一定误差范围的支付场景

**修约规则：**

- 根据订单金额的小数位数确定修约精度
- 对实际交易金额按该精度进行四舍五入
- 比较修约后的金额与订单金额是否相等

**举例：**

| 订单金额    | 实际交易金额   | 修约后金额   | 匹配结果   | 说明                      |
|---------|----------|---------|--------|-------------------------|
| 100.00  | 100.004  | 100.00  | ✅ 匹配成功 | 保留2位小数，0.004四舍五入为0.00   |
| 100.00  | 100.005  | 100.01  | ❌ 匹配失败 | 保留2位小数，0.005四舍五入为0.01   |
| 99.50   | 99.498   | 99.50   | ✅ 匹配成功 | 保留2位小数，0.498四舍五入为0.50   |
| 99.50   | 99.494   | 99.49   | ❌ 匹配失败 | 保留2位小数，0.494四舍五入为0.49   |
| 88.5    | 88.51    | 88.5    | ✅ 匹配成功 | 保留1位小数，0.51四舍五入为0.5     |
| 88.5    | 88.49    | 88.5    | ✅ 匹配成功 | 保留1位小数，0.49四舍五入为0.5     |
| 88.5    | 88.45    | 88.5    | ✅ 匹配成功 | 保留1位小数，0.45四舍五入为0.5     |
| 123.456 | 123.4564 | 123.456 | ✅ 匹配成功 | 保留3位小数，0.0004四舍五入为0.000 |

---

## 选择建议

- **传统模式**：适合金额固定、对准确性要求高的场景
- **前缀匹配**：适合仅允许用户多付、可能添加额外精度的场景
- **修约匹配**：适合允许用户多付或者少付，容忍度更高的场景

根据实际业务需求选择合适的匹配模式，可以在保证安全性的同时提升用户体验。
